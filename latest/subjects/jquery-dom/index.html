<!DOCTYPE html>
<html>
  <head>
    <title>jQuery - DOM Manipulation (MAS-RAD | CAS-DAR | Developpement Frontend Avanc√©)</title>
    <meta charset='utf-8'>
    <meta name='config' content='{&quot;basePath&quot;:&quot;../..&quot;,&quot;remark&quot;:{&quot;highlightLines&quot;:true,&quot;highlightSpans&quot;:true,&quot;countIncrementalSlides&quot;:false,&quot;navigation&quot;:{&quot;click&quot;:false,&quot;scroll&quot;:false,&quot;touch&quot;:true}},&quot;subjectUrl&quot;:&quot;https://github.com/MediaComem/comem-masrad-dfa/tree/91f6e0a0ea57c6186ddfa383df3a9dce5439db82/subjects/jquery-dom/README.md&quot;}'>
  </head>
  <body>
    <textarea id='source'>
class: center, middle
# jQuery - DOM Manipulation



---
## Summary

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]

Learn how to use the jQuery library to manipulate the DOM of a web page and creating interactivity.

This material is part of the [Advanced Front-end Development](https://github.com/MediaComem/comem-masrad-dfa) for the [Master of Advances Studies in Rapid Application Development](https://www.he-arc.ch/ingenierie/mas-rad-cas-dar).


**You will need**

- [Google Chrome][chrome] (recommended, any browser with developer tools will do)
- [Visual Studio Code][vscode] (recommended, although any editor could do)
- [Live-Server][ls] (should already be installed)

**Recommended reading**

- [JavaScript][js]
- [Bootstrap][bs]



---
## Setup

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]

1. Create a new folder in your `dfa-course` folder. We'll call it `jquery-dom`
1. Save [this `index.html` file][ex-file] in the new folder.
  > Note that this example file includes Bootstrap through a CDN. Feel free to change that to a local link if you'd prefer ([see here][local-bs]).
1. Start `live-server` and you should see the following page:

<p class="center"><img src="images/final-result.png" class="shadow" width="70%" /></p>

---
## Include jQuery

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]

To add jQuery in your project, you can include it via a CDN link, in your `index.html` file:

```html
<body>
  ...
  <script
    src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>
&lt;/body>
```

You can also [download the complete file][dl-jquery], and save the file in a `js` directory in your project directory. Then, include the file in your `index.html`:

```html
<body>
  ...
  <script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
&lt;/body>
```

> Wait... am I not supposed to put my `<script>` tags in the `<head>`?
>
> What are they doing right before the closing `&lt/body>` tag?

---
### Script inclusions

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#4">Include jQuery</a>]

It's considered [a good practice][js-in-body] to include JS scripts **at the end of your HTML page**.

When your browser loads the JS, it doesn't just load the file. It also **parses** it.

Parsing the JS files **pauses the load of all other resources**, effectively blocking everythig until the JS has been completely parsed.

> This can result in **slow loading pages**, especially when you have multiple or big scripts.

Plus, loading JS files before the DOM is complete forces you to do all your intial DOM access in a `window.onlad = function {}` callback.

> With `<script>` tags at the and of the `<body>`, the DOM is completely loaded **before** your script, and your code can safely access it.

---
### Add custom script

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#4">Include jQuery</a>]

We will write our JS code in a custom script file.

In your `jquery-dom` folder, create a new file `script.js` and include it at the bottom of your `index.html` page:

```html
<body>
  ...
  <script type="text/javascript" src="script.js"></script>
&lt;/body>
```

> Be extra-sure to include your custom `script.js` file **after** the inclusion of the jQuery file.

---
### Test everything

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#4">Include jQuery</a>]

Add the following line in your `script.js` file, and save it:

```js
console.log($("body").jquery);
```

Access your browser's console and you should see the following lines:

```bash
3.4.1
Live reload enabled.
```

> If it's the case, jQuery and your custom script are both correctly include in your project.

> You can now empty your `script.js` file

---
## Learn by example

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]

For the rest of this course, we are going to discover how to do things with jQuery by implementing features on the example template.

These features are:

- Select another discussion in the left list, and reset the unread indicator

- Change the alignment of the "New message" area, using the three buttons

- Add a new message to the discussion when clicking on the "Send" button

- Remove messages from the discussion when clicking on the trash button

---
class: center, middle, image-header
## What is jQuery

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]



<p class='center'><img src='images/jquery-logo.png' width='30%' /></p>

> jQuery is a JavaScript library created in 2006 by John Resig, and originally designed to ease the creation of client-side JS script, especially regarding DOM manipulation.

> **This subject is based on the `3.4.1` version of jQuery.**

---
class: center, middle
## jQuery documentation

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]

Everything that is presented in this subject can also be found in **the jQuery documentation**, along with lot of **examples** and **information**.

We highly recommend that you check it out.

[jQuery Documentation][jq-doc]



---
## The `$` identifier

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]

The complete jQuery library is accessible in your JS code through the use of a global variable named `$`.

Note that other libraries could also use a variable named `$` as their main entrypoint.

> That could cause some conflict between jQuery and those librairies.

Although it won't be the case in this subject, you could instead use the global `jQuery` variable to access the jQuery API in your code.

To be sure to remove all possible conflicts, you can use the special `.noConflict()` jQuery method at the top of your JS file:

```js
$.noConflict();
// Code that uses other library's $ can follow here.
// But use the jQuery variable to access jQuery's method.
```

---
## Selecting things

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]

Being a library designed to easily handle DOM manipulation, jQuery allows you to... easily select DOM elements.

To do so, use the `$(...)` function, passing it a **selector** as its first parameter. This selector uses **the same syntax as the [CSS Selectors][css-select] syntax**.

| Selector | CSS example | jQuery           | Result                                     |
| :------- | :---------- | :--------------- | :----------------------------------------- |
| Element  | `p`         | `$("p")`         | **All** `<p>` elements in the page         |
| Id       | `#username` | `$("#username")` | **Unique** elements with the `username` id |
| Class    | `.row`      | `$(".row")`      | **All** elements with a `row` class        |

Two things are worth mentionning about this `$(...)` function:
1. It never returns **DOM element** _per-se_ but wraps them in **a jQuery object** that adds many features to them.
1. Even when using an Id selector, which should select one element, the function returns **an `array` of jQuery objects**.

---
### Good selecting practice

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#12">Selecting things</a>]

The syntax for selecting elements in jQuery being [very vast][css-select], you can easily write selectors that aren't optimals, performace-wise.

> Traversing the DOM is a **costly operation**. Your jQuery selectors (and your CSS ones as well) should try to be **as to-the-point as possible**.

There's many good practice regarding jQuery selectors. We are only going to see a few of them.

<hr>

> Note that the following example contains some jQuery method we haven't yet seen.
>
> **Don't mind them now, we will explicit those methods later on this subject.**

---
#### Storing jQuery object

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#12">Selecting things</a> > <a href="#13">Good selecting practice</a>]

When you know or discover that your are going to use the same jQuery selector **several time**, you should cache its result **in a variable**, for future reference.

**Bad!**

```js
$("article > p:first-child").addClass("catch-phrase");
$("article > p:first-child").text("This is a very pertinent article");
$("article > p:first-child").append("<span>CLICK ME!</span>");
```

**Way better!**

```js
const `$firstSentences` = $("article > p:first-child");
`$firstSentences`.addClass("catch-phrase");
`$firstSentences`.text("This is a very pertinent article");
`$firstSentences`.append("<span>CLICK ME!</span>");
```

> **Preceding** a variable name with **the `$` character** is some kind of a convention, when working with jQuery, to indicate that **this variable contains jQuery object(s)**.

---
#### Use `id` selectors

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#12">Selecting things</a> > <a href="#13">Good selecting practice</a>]

HTML `id` attribute allows you to define **unique identifier** in an HTML page.

Thanks to this uniqueness, element with `id` attributes are **extremly fast to retrieve** in the DOM, even with older browsers.

> As much as possible, you should add `id` attributes to HTML elements that you'll select.

```html
<div class="panel-body">
  <p><!-- content --></p>
  <p id="the-one"><!-- content --></p>
  <p><!-- content --></p>
</div>
```

This...

```js
$("div.panel-body p:nth-of-type(2)");
```

...will be way **slower** than this.

```js
$("#the-one");
```

---
#### Don't overselect things

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#12">Selecting things</a> > <a href="#13">Good selecting practice</a>]

If you can't define `id` attributes in your HTML template, you'll need to use more complete selectors.

When doing so, you might be tempted to be **as exhaustive as possible**, in order to be sure you'll get the right element(s).

Like this for example:

```js
$("html body main.container div.list-group a.list-group-item h4");
```

> This is completely **unnecessary** and a **waste of resources**.

You want to be precise with your selector to avoid getting things you don't want. But being over-precise is **as bad** as being too vague.

We could simplify the precedent example like this:

```js
$("a.list-group-item h4");
```

> Knowing your HTML structure is **mandatory** in order to write good jQuery selectors.

---
#### Using `class` selector

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#12">Selecting things</a> > <a href="#13">Good selecting practice</a>]

CSS classes being shared among elements, it's a great way to quickly select all related elements.

```js
// Will select all items from list-group lists.
$(".list-group-item");
```

But there's a drawback.

With `class` selector, jQuery will parse **all the DOM** and test **every single node** to see if it has the given class (or classes). This is possibly very inefficient.

Thus, you should try to be **as precise as possible** when using `class` selector, by qualifying it with a tag name, for example.

In our example, we know that the `.list-group-item` should only be applied to `<li>` or `<a>` element. So:

```js
// Will select only <li> and <a> that have the class
$("li.list-group-item, a.list-group-item");
```

---
#### Selecting order

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#12">Selecting things</a> > <a href="#13">Good selecting practice</a>]

When jQuery encounters a selector like `$("a.list-group-item h4")`, how do you think it's going to execute it ?

> You might think that jQuery will fetch all the `a.list-group-item` first, then fetch all `h4` inside them.

This is **not** the case. In fact, it's the **complete opposite**.

To begin with, jQuery will fetch all `<h4>` in the page, and store them in an `array`.

Then, it will examine each of these `<h4>`, and reject the ones that don't have an `a.list-group-item` as parent.

> If you have many `<h4>` in your page or a far-too-precise selector, jQuery will take unnecessary time to process the selector.

To solve this problem, you have two options:

- Use the `.find(...)` method on the parent object.
- Narrow the context by using the second parameter of the `$(...)` function.

---
##### Try to `.find()` me

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#12">Selecting things</a> > <a href="#13">Good selecting practice</a> > <a href="#18">Selecting order</a>]

The `.find(...)` method allows you to search for **elements in the DOM**, but limited to the context of the jQuery object on which you called the method.

If we use the previous example again (the `$("a.list-group-item h4")` case), we would use the method like this:

```js
$("a.list-group-item").find("h4");
```

> We first fetch the `a.list-group-item`, then we search for `h4` elements **inside** the retrieved `a.list-group-item` elements.

---
##### Refine the use of `$(...)`

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#12">Selecting things</a> > <a href="#13">Good selecting practice</a> > <a href="#18">Selecting order</a>]

We said before that `$(...)` is the function to use to **retrieve DOM elements**.

Its first parameter is **the selector** for those elements.

But the function also have a second (optional) parameter, which is the **context in which the search is conducted**.

By default, the context is the complete HTML page, but you can pass it **any object representing a subset of the DOM**.

For the previous example, we could write our selector like this:

```js
// First, we retrieve all the list-group items
const $listElements = $("a.list-group-item");

// Then we search for <h4> element, but only in the subset of the Dom
// contained in the previously retrieved elements
$("h4", $listElements);
```

In a more compressed style, it would resemble this:

```js
$("h4", $("a.list-group-item"));
```

---
class: center, middle
## Feature : _"Select discussion item"_

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]



---
class: middle
### Template update N¬∞1

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#21">Feature : _"Select discussion item"_</a>]

For **better UI behavior**, we need to tell our browser to show the **click pointer icon** when passing over our discussion list items.

Add this line in the `<style>` tag, after the `main` style:

```css
.list-group-item {
  cursor: pointer;
}
```



---
### Events

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#21">Feature : _"Select discussion item"_</a>]

Most of the functionnalities we'll implement will rely on things being **clicked**.

> jQuery can handle more events than just click, [see here][jq-events].

Use the `.click(...)` method to add a click event on an element.

> The `.click(...)` method needs a callback function as its argument, that will be called with **one argument**: the **fired event**

In order to select another discussion, we need to add a `click` event to the **list elements**.

Add this code in your `script.js` file:

```js
$("a.list-group-item").click(function (event) {
  console.log(event);
});
```

Now, go to your page, open your console and try to **click** on one of the list item.

> You should see the object representing the event.

---
#### `this`? `$(this)`?

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#21">Feature : _"Select discussion item"_</a> > <a href="#23">Events</a>]

When writing event callback functions you might want to retrieve **the DOM element that triggered the event**.

You can do that with the property `currentTarget` of the event object:

```js
$("a.list-group-item").click(function (event) {
  console.log(`event.currentTarget`);
});
```

More simply, use the `this` keyword to achieve the **same purpose**:

```js
$("a.list-group-item").click(function (event) {
  console.log(`this`);
});
```

Since we are using jQuery, we'd prefer retrieving a **jQuery object** representing this DOM element.

Do that by passing `this` to the `$(...)` function:

```js
$("a.list-group-item").click(function (event) {
  console.log(`$(this)`);
});
```

---
### Add a CSS class

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#21">Feature : _"Select discussion item"_</a>]

On the page, there is one list item that has a different style.

This is **the currently selected item**, and the effect is achieved using the `.active` class from the Bootstrap framework.

When another list item will be clicked we want to **switch the active state** from the previous list item to the one being activated.

This means adding the `.active` CSS class **to the currently clicked element**.

Use the `.addClass(...)` method to do that, and pass it a `string` with the **name of the classes** to be added, separated by a **space**.

```js
$("a.list-group-item").click(function(event) {
  // Add the 'active' class to the clicked list item
* $(this).addClass("active");
});
```

> Go on your page, and click on your list items.

> The class is correctly added. Next step is to **remove this class** from the previsouly active element.

---
### Remove a CSS class

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#21">Feature : _"Select discussion item"_</a>]

To remove a CSS class from an element, simply use the `.removeClass(...)` method.

> Pass it a `string` argument with the names of the classes to be removed, separated by a space.

Now, we want to remove the active state from the previously selected list element.

This element is a `a.list-group-item` with the `.active` class.

```js
$("a.list-group-item").click(function(event) {
  // Remove the 'active' class from the previously selected list item
* $("a.list-group-item.active").removeClass("active");
  // Add the 'active' class to the clicked list item
  $(this).addClass("active");
});
```

> Note how we append the `.active` class to our selector.

Trying to remove a CSS class from an element that **didn't have it** in the first time will **not raise any error**, fortunately.

---
### Change the content

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#21">Feature : _"Select discussion item"_</a>]

Now that we can changed the selected discussion list item, we want to **remove the notification** about unread messages, that is the badge in the item.

For that we will **change the content** of the `span.badge` inside the list item.

Use the `.text(...)` method to do so, and pass it as argument a `string` that represents the **new content**.

> Calling the method with **no argument** returns the **current** content.

In our case, since we want to remove the content of the element, we'll use an empty `string` (`""`):

```js
$("a.list-group-item").click(function(event) {
  /* Add this after previous code */

  // Remove the unread notification
* $("span.badge", this).text("");
});
```

> Note that we used the `this` keyword as context when searching for the `span.badge` element, since `this` represents the list item.

---
### Complete code

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#21">Feature : _"Select discussion item"_</a>]

Here's the complete code for this feature:

> For better readability and structure, we've splitted the **event declaration** from the **function implementation**.

```js
$("a.list-group-item").click(`switchListItem`);

*function switchListItem() {

  // Change the active state to the clicked item
  $("a.list-group-item.active").removeClass("active");
  $(this).addClass("active");

  // Clear the unread notification for the clicked item
  $("span.badge", this).text("");
}
```

> Note that we passed the `switchListItem` function as parameter to the `.click(...)` method **without parenthesis**.

> We dont' want to **execute the function**, we just want to pass its **reference**.

---
class: center, middle
## Feature : _"Change message alignment"_

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]



---
class: middle
### Template update N¬∞2

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a>]

For the next feature, we will need to **add some `id`** in our `index.html` page.

At the **line 173**, add this `id` to the `<textarea>` element:

```html
&lt;textarea id="`message`" [...] &gt;&lt;/textarea&gt;
```

At the **line 178**, add this `id` to the `<div>` element:

```html
<div class="btn-group btn-group-sm" id="`align-btns`"></div>
```



---
### Attach the events

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a>]

Our three alignment buttons are all children of the same element, which is the `div#align-btns`.

We can thus use this element in our selector to access the buttons:

```js
$("#align-btns button")...
```

> We have seen that this kind of notation can be optimized.
>
> Let's use the second paramter of `$(...)` to retrieve the buttons, and then attach them the event:

```js
$("button", $("#align-btns")).click(function (event) {
  console.log(this);
});
```

> **"What is this strange behavior?"** you might say, **"The page is reload each time a button is clicked. Why?"**

---
#### Buttons in a form

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a> > <a href="#31">Attach the events</a>]

If you look closely to the HTML structure in which the `button`s are placed, you'll see that they are placed **inside a form**:

```html
*<form>
  <!-- textarea element -->
  <div class="btn-group btn-group-sm"
    id="align-btns">
    <button class="btn btn-outline-secondary active">
      <i class="fas fa-align-left"></i>
    </button>
    <button class="btn btn-outline-secondary">
      <i class="fas fa-align-center"></i>
    </button>
    <button class="btn btn-outline-secondary">
      <i class="fas fa-align-right"></i>
    </button>
  </div>
  <!-- send button -->
*</form>
```

> Clicking on a `<button>` that's placed inside a `<form>` will trigger the submission of said `<form>`.

> **That's a default behavior that we don't want.**

---
### Prevent default behavior

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a>]

Remember that the **callback function** called when an event is triggered has one parameter, which is **the triggered event object** ?

This event object will **trigger the default behavior** attached to it **after** our code is executed, **unless we say it otherwise**.

The `.preventDefault()` method of the event object is rightly there for this purpose.

Let's call this method at the last line of our callback function:

```js
$("button", $("#align-btns")).click(function(event) {
  console.log(this);
  // Prevent the default submit behavior
* event.preventDefault();
});
```

> Clicking on the button will now no longer reload the page.

---
### Change button state

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a>]

The _align left_ button is constantly in an active state. This effect is achieved by using the `.active` class from the Bootstrap framework.

In the same fashion as the state of the discussion list item, we will want to switch the state when a button is pressed.

This is the code that achieve that:

```js
$("button", $("#align-btns")).click(function(event) {
  // Change the active state when a button is clicked
* $("button.active", $("#align-btns")).removeClass("active");
* $(this).addClass("active");

  // Prevent the default submit behavior
  event.preventDefault();
});
```

> Go on your page, and click on the alignment button, then click somewhere else, and **observe how your button react**.

> You should see that **its style changes**. Thanks to Bootstrap, when a button is clicked, **a border is added**, that disappear when you click elsewhere.

---
### Managing the focus

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a>]

This is related to the **focus**, that is an indication of the element in the page that you're currently "using".

Focusing in or out of an element is an **event** to which you can react with JS and/or jQuery.

But you can also **force-activate** those events on elements within your code.

In our case, we want to **focus out of the button** once it has been clicked.

This event of focusing our an element is called `blur`, and can be activated by using the `.blur()` jQuery method:

```js
$("button", $("#align-btns")).click(function(event) {
  // Change the active state when a button is clicked
  $("button.active", $("#align-btns")).removeClass("active");
  $(this).addClass("active");
* $(this).blur();
  // Prevent the default submit behavior
  event.preventDefault();
});
```

---
### Chaining method calls

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a>]

In the previous code example, you might have seen that we called, one after the other, **two different methods on the same object**:

```js
$(this).addClass("active");
$(this).blur();
```

jQuery allows you to call **several methods on the same line**.

> This is called **method chaining**.

In our case, we can do that...

```js
$(this).addClass("active").blur();
```

...because the `addClass(...)` returns the object that called it, here `$(this)`, on which we can call `.blur()` right away.

> You need to be aware of **what is returned** by each method if you want to use method chaining.

---
#### Be cautious

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a> > <a href="#36">Chaining method calls</a>]

Remember what the `.find(...)` method does?

```js
$("#align-btns").find("button");
```

> The `.find(...)` method here will return all the `button` elements that it's found inside the `#align-btns` element.

Thus, methods chained after a call to `.find(...)` will **not be applied** to the `$("#align-btns")` object:

```js
$("#align-btns").find("button")`.addClass("active")`;
```

> The `active` class will be applied to each objects returned from `.find(...)`.

If you'd want to apply the `.addClass(...)` method to the `$("#align-btns")` object first, you'd need to write it like this:

```js
$("#align-btns")`.addClass("active")`.find("button");
```

---
### Planning the logic

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a>]

Now that our buttons behave as expected, let's make them concretly **change the text alignment** in the "New message" area.

Bootstrap has **three utility classes** that helps you manage text-alignment:

- `.text-left`
- `.text-center`
- `.text-right`

So, all we need to do, in our callback function, is:

1. Detect **which button** has been clicked
2. **Remove any precedent alignment class** from the `#message` element
3. **Add the correct alignment class** to the `#message` element

---
### Detect the button

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a>]

To detect which button has been click we _could_ add an `id` to each button.

But, in the HTML, we can see that there is already something that could help us in that task: the icon.

```html
<div class="btn-group btn-group-sm"
  id="align-btns">
  <button class="btn btn-outline-secondary active">
*   <i class="fas fa-align-left"></i>
  </button>
  <button class="btn btn-outline-secondary">
*   <i class="fas fa-align-center"></i>
  </button>
  <button class="btn btn-outline-secondary">
*   <i class="fas fa-align-right"></i>
  </button>
</div>
```

> We need to retrieve the `<i>` element inside the button, then check what class this `<i>` has.

---
### Do you have _any_ class?

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a>]

The `.hasClass(...)` method can detect if the element possesses the class name given as parameter.

> This method returns a boolean (`true`/`false`).

```js
// Will return true
$("li.active").hasClass("active");
```

Let's retrieve the `<i>` inside the clicked button and check, for example, if it has the `.fa-align-right` class:

```js
$("button", $("#align-btns")).click(function(event) {
  /* Previous code */
  $(this).addClass("active").blur();

* if ($("i", this).hasClass("fa-align-right")) {
    // The clicked button is the one for align to the right.
  }

  /* Following code */
});
```

---
#### if ... else if ... else

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a> > <a href="#40">Do you have _any_ class?</a>]

Using a `if ... else if ... else` structure, we can complete our test:

```js
$("button", $("#align-btns")).click(function (event) {
  // Change the active state when a button is clicked
  $("button", $("#align-btns")).removeClass("active");
  $(this).addClass("active").blur();

  if (`$("i", this).hasClass("fa-align-right")`) {
    // The clicked button is the one to align to the right
    console.log("Align to the right!");
  } else if (`$("i", this).hasClass("fa-align-center")`) {
    // The clicked button is the one to align to the center
    console.log("Align to the center!");
  } else {
    // The clicked button is neither the one to align to the right
    // nor the one to align to the center...
    // It must be the one to align to the left, then!
    console.log("Align to the left!");
  }

  // Prevent the default submit behavior
  event.preventDefault();
});
```

> Go on and try that.

---
### Finally... change the alignment!

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a>]

**When the** _align-right_ **button has been clicked:**

```js
if ($("i", this).hasClass("fa-align-right")) {
*   $("#message").removeClass("text-left text-center").addClass("text-right");
}
```

**When the** _align-center_ **button has been clicked:**

```js
else if ($("i", this).hasClass("fa-align-center")) {
*   $("#message").removeClass("text-right text-left").addClass("text-center");
}
```

**When the** _align-center_ **button has been clicked:**

```js
else {
*   $("#message").removeClass("text-right text-center");
}
```

> We don't have to add the `.text-left` class because, by default, the text is aligned to the left in HTML elements.

---
### Complete code

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#29">Feature : _"Change message alignment"_</a>]

Here's the complete code for this feature:

> For better readability and structure, we've splitted the **event declaration** from the **function implementation**.

```js
$("button", $("#align-btns")).click(changeAlignment);

function changeAlignment(event) {
  // Change the active state when a button is clicked
  $("button", $("#align-btns")).removeClass("active");
  $(this).addClass("active").blur();

  // React to the adequate clicked button
  if ($("i", this).hasClass("fa-align-right")) {
    $("#message").removeClass("text-left text-center").addClass("text-right");
  } else if ($("i", this).hasClass("fa-align-center")) {
    $("#message").removeClass("text-right text-left").addClass("text-center");
  } else {
    $("#message").removeClass("text-right text-center");
  }

  // Prevent the default submit behavior
  event.preventDefault();
}
```

---
class: center, middle
## Feature : _"Add new message"_

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]



---
class: middle
### Template update N¬∞3

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a>]

For the next feature, we will need to **add some `id`** in our `index.html` page.

At the **line 120**, add this `id` to the `<div>` element:

```html
<div class="card-body" id="`dialog`"></div>
```

At the **line 190**, add this `id` to the `<button>` element:

```html
<button class="btn btn-success pull-right btn-sm" id="`send-btn`"></button>
```



---
### The basics

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a>]

The "Send" button is **also located inside the form**. So we need to **cancel** its default behavior when it's clicked:

```js
$("#send-btn").click(function (event) {
  // Do the thing!

  event.preventDefault();
});
```

Now... we'll have to..:

1. Get the value inside `#message`
1. _No value_ ?
  1. Notify the user
  1. Reject the creation
1. _Value_ ?
  1. Get the alignment for the new message
  1. Create the new message DOM structure
  1. Append the new message to the discussion
  1. Reset the textearea (error and content)

---
### Get the value inside `#message`

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a>]

To get the value of a form `<input>` or `<textarea>`, you can use the `val()` method in one of those elements:

```js
// Will return "" if the textearea is empty
$("#message").val();
```

But since we will refer to the `#message` element **several time** in our code, we might as well **cache its reference** in a variable:

```js
$("#send-btn").click(function(event) {
* const $message = $("#message");

  event.preventDefault();
});
```

Now, we can get the value:

```js
$("#send-btn").click(function(event) {
  const $message = $("#message");
* const msgValue = $message.val();
  event.preventDefault();
});
```

---
### Validation phase

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a>]

The first thing we need to do, before actually going on with the message insertion, is **some validation**.

In this case, we want to **reject** the creation of the new message if there is no new message to create, i.e. when the "New message" text-area is **empty**.

Let's prepare the logic structure:

```js
$("#send-btn").click(function(event) {
  /* Get the value */
* if (msgValue === "") {
    // No message -> Error handling
* } else {
    // There's a message, let's go and create it.
  }
  event.preventDefault();
});
```

---
#### Error! Error! Err...

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a> > <a href="#48">Validation phase</a>]

Now, if our new message is **empty**, we want to **notify the user** and **stop** the new message insertion.

There's **many ways** to notify the user when an error occurs in a form.

As a matter of fact, Bootstrap provides you with some classes for this, that you can apply to **[many form elements][bs-validation]**:

- `.is-invalid`
- `.is-valid`

The one we'll use is `.is-invalid`:

```js
$("#send-btn").click(function(event) {
  /* Preceding code */
  if (msgValue === "") {
*   $message.addClass("is-invalid");
  }
  /* Following code */
});
```

---
### What's your alignment?

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a>]

When the message value **contains something**, we need to retrieve the **correct alignment class** to apply to the future new message in the discussion.

Let's create a new **function **that will take **one argument**, a jQuery object, and returns **the name of the correct class**.

> We will use the returned value when creating the new message DOM structure.

```js
// Add this anywhere in your script file.
function getAlignmentClass($ele) {
  if ($ele.hasClass("text-right")) {
    return "text-right";
  } else if ($ele.hasClass("text-center")) {
    return "text-center";
  } else {
    return null;
  }
}
```

> We don't need to return the `.text-left` class, since it's the by-default alignment if no class is provided.

---
#### Use the function

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a> > <a href="#50">What's your alignment?</a>]

Now, we can use our freshly created function to actually retrieve the desired alignment.

```js
$("#send-btn").click(function(event) {
  const $message = $("#message");
  const msgValue = $message.val();

  if (msgValue === "") {
    $("#message").addClass("is-invalid");
  } else {
*   const alignment = getAlignmentClass($message);

    // Next operations...
  }
  event.preventDefault();
});
```

---
### Create the HTML structure

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a>]

We now have to create all the HTML structure necessary to add a new message to the dialog card.

Since we are using Bootstrap, here is the complete structure we'll have to create (its exactly the one used for the messages already in the page):

```html
<div class="col-8 offset-4">
  <div class="alert alert-warning">
    <div class="d-flex justify-content-between align-items-center">
*     <div class="msg-content flex-grow-1 mr-2">
        <!-- The text goes here -->
*     </div>
      <div>
        <small class="text-info"><!-- The time goes here --></small>
        <button class="btn btn-link btn-sm">
          <i class="far fa-trash-alt"></i>
        </button>
      </div>
    </div>
  </div>
</div>

```

> The `div.msg-content` will help use insert the message in this tempalte later.

---
#### The `$(...)` function, again

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a> > <a href="#52">Create the HTML structure</a>]

With jQuery, you can create HTML elements using the `$(...)` function.

If you pass a `string` as argument and this `string` looks like HTML, you'll get a jQuery object containing the corresponding node structure.

```js
// Will create a new <p>
const $html = $("<p>");
```

You can even pass more complex HTML string to the function:

```js
// Will create a new <p> and give it some content
const $html = $("<p>This is a new paragraph with content</p>");
```

So... technically... we could create the new message by doing this:

```js
const $html = $('<div class="col-md-8 col-md-offset-4"><div class="alert alert-warning"><!-- The text goes here --><div class="pull-right"><small class="text-info"><!-- The time goes here --></small><button class="btn btn-link btn-xs"><span class="glyphicon glyphicon-trash"></span></button></div></div></div>');
```

> This is obviously **not** a good solution:
>
> - Extremly long string
> - Unreadable and unmaintainable
> - Strong coupling between template and logic

---
#### The `<template>` tag

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a> > <a href="#52">Create the HTML structure</a>]

Ideally, we would like to write our template **in our `.html` file**, then retrieve and manipulate it with jQuery.

Thankfully, there's a special tag for that in HTML: [the `<template>` tag][template].

> Any content in a `<template>` tag won't be displayed on screen or read by screen-readers, but can be accessed and used in JS scrpts.

```html
<template>
  <!-- Content goes here -->
</template>
```
You can place those templates anywhere on your page, but it's best to regroup them e.g. at the end of your `<body>` tag (but before the `<script>` tags).

> around the **line 203**, in our example

We can give it an `id` for future reference, and copy our HTML inside:

```html
<template `id="new-sent-message"`>
  <!-- Content goes here -->
</template>
```

---
#### Recovering the template

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a> > <a href="#52">Create the HTML structure</a>]

To retrieve a template as a jQuery object, we need to do two operations.

First get the content of the `<template>` tag:

```js
const template = $("#new-sent-message").html();
```

> This will return the HTML structure as a `string`.

Then generate a new DOM structure based on this content:

```js
const $msgTemplate = $(template);
```

> `$msgTemplate` now contains a jQuery object for the desired DOM.

We can manipulate this DOM, and append it to our page.

> Note that you could also define the template in its own file (without the `<template>` tag of course), then retrieve its content with an [AJAX request][ajax] and create a jQuery object with it.

---
### Code checkpoint

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a>]

With the addition of these lines, our JS code for the new feature should be:

```js
$("#send-btn").click(function (event) {
  // Getting the "New message" input
  const $message = $("#message");

  // Getting the new message text
  const msgValue = $message.val();

  if (msgValue === "") {
    // If the new message is emplty, show an error
    $message.addClass("is-invalid");
  } else {
    // Get the correct alignment
    const alignment = getAlignmentClass($message);

    // Get the new message template
    const template = $("#new-sent-message").html();
    const $msgTemplate = $(template);
  }
  event.preventDefault();
});
```

---
### Fill in the template

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a>]

Next step is to **insert the values** for this new message. We have two values to add:

- The new message content
- The time at which the message has been sent

Adding the new message is simple ; we need to **retrieve the `div.msg-content`** in the template node tree, and **insert the content of the `msgValue` variable**.

```js
$("#send-btn").click(function(event) {
  /* Previous code */
  else {
    // Get the correct alignment
    const alignment = getAlignmentClass($message);

    // Get the new message template
    const template = $("#new-sent-message").html();
    const $msgTemplate = $(template);

*   $("div.msg-content", $msgTemplate).text(msgValue);

  }
  event.preventDefault();
});
```

---
### Getting the date

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a>]

To get the message date, let's create a **function** that returns just that.

We will use the JS Date feature for that.

- The `Date()` function creates a new `Date` object representing the current date
- The `toLocalTimeStrin(...)` method of a `Date` object allows you to return a localized string representation of said date. You can pass an option object to change how the time is displayed.
  > In our case, we will display the date in Swiss French format (with the `fr-CH` locale), and two digits for hours and minutes.

Using all that together:

```js
function getCurrentTime() {
  const date = new Date();
  return date.toLocaleTimeString("fr-CH", {
    hour: "2-digit",
    minute: "2-digit"
  });
}
```

---
#### Add the date

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a> > <a href="#58">Getting the date</a>]

Back to our new message function, we get the `small.text-info` element from the new message template that'll contain the time and **insert** the correct value:

```js
/* Previous code */
$("small.text-info", $msgTemplate).text(getCurrentTime());
/* Following code */
```

---
### Apply the alignment

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a>]

Remember we retrieved the **correct alignment to apply** to the new message? Now's the time to actually apply it.

For that, we need to **add the class** whose name is stored in the `alignment` variable, if any.

> If the content of the new message should be aligned to the left, `alignment` contains `null`.

```js
$("#send-btn").click(function(event) {
  /* Previous code */
  else {
    /* Previous code */
    $("small.text-info", $msgTemplate).text(getCurrentTime());

*   if (alignment) $msgTemplate.addClass(alignment);
  }
  event.preventDefault();
});
```

---
### Insert in the discussion

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a>]

We have the **complete DOM structure** for our new message stored in **a jQuery object** inside the `$msgTemplate` variable.

Let's **insert this new message in our page**. To do this, we'll use the `.append(...)` method.

> This method append the given jQuery object at the end of the jQuery object on which the method is called.

```js
$("#send-btn").click(function(event) {
  /* Previous code */
  else {
    /* Previous code */
    if (alignment) $msgTemplate.addClass(alignment);

*   $("#dialog").find("div.row").append($msgTemplate);
  }
  event.preventDefault();
});
```

Finally, let's clean-up a bit, by adding this at the end of the `else` block:

```js
// Remove the content from the #message element.
$message.val("");
```

---
### Complete code - Functions

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a>]

**`getAlignmentClass(...)`**

```js
// Get the alignment class name applied to the given element.
// If it's the default alignement (left), returns null.
function getAlignmentClass($ele) {
  if ($ele.hasClass("text-right")) {
    return "text-right";
  } else if ($ele.hasClass("text-center")) {
    return "text-center";
  } else {
    return null;
  }
}
```

**`getCurrentTime()`**

```js
// Returns the current time in a HH:MM formatted string
function getCurrentTime() {
  const date = new Date();
  return date.toLocaleTimeString("fr-CH", {
    hour: "2-digit",
    minute: "2-digit"
  });
}
```

---
### Complete code - Event callback

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#44">Feature : _"Add new message"_</a>]

```js
$("#send-btn").click(createNewMessage);

function createNewMessage(event) {
  // Getting the "New message" value
  const $message = $("#message");
  const msgValue = $message.val();

  if (msgValue === "") {
    $message.addClass("is-invalid");
  } else {
    // Get the correct alignment
    const alignment = getAlignmentClass($message);

    // Get the new message template
    const template = $("#new-sent-message").html();
    const $msgTemplate = $(template);

    // Insert the value in the tempalte
    $("div.msg-content", $msgTemplate).text(msgValue);
    $("small.text-info", $msgTemplate).text(getCurrentTime());
    if (alignment) $msgTemplate.addClass(alignment);

    // Add the template to the page
    $("#dialog").find("div.row").append($msgTemplate);
    $message.val("");
  }
  event.preventDefault();
}
```

---
class: center, middle
## Feature : _"Remove messages"_

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]



---
### The `.remove()` method

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#64">Feature : _"Remove messages"_</a>]

Removing something in jQuery is quite simple. Just use the `.remove()` method on a jQuery object, and the DOM it represents will be **removed from the page**.

Our event should be attached to all the `button` elements that contains a `i.fa-trash-alt` element:

```js
$("i.fa-trash-alt").parent().click(function (event) {});
```

But since the event is on the `button` element, we need to **travel up the DOM tree** to find the `button`s parent that correspond to the complete message.

We could use the `.parent()` method to travel up step by step, which would give a code like this:

```js
$(this).parent().parent().parent().remove();
```

> This works... but it's certainly not a good option.

???

- We need to thouroughly analyze the HTML structure to count the number of steps we need to go.
- What if the HTML structure changes and a new structure level is added? We would have to change our code...

---
### Get closer

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#64">Feature : _"Remove messages"_</a>]

In our case, the element that we want to access is the `div.col-8`. But there's multiple `div.col-8` in our page, so we don't want any `div.col-8`; we want the closest one to our button.

We can then use the `.closest(...)` method and give it the selector of the element we want to retrieve:

```js
$("i.fa-trash-alt").parent().click(function (event) {
  console.log($(this).closest("div.col-8"));
});
```

> This will correctly return you the `<div>` that contains the complete message to remove.

Let's remove it!

```js
$("i.fa-trash-alt").parent().click(function (event) {
  $(this).closest("div.col-8").remove();
});
```

> Go on your page, and try to remove a message.

> Now... add a new message and try to remove it.

---
### Time paradox

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#64">Feature : _"Remove messages"_</a>]

The fact that the DOM node is not removed is caused by the way the JS code is interpreted by the browser.

Actually, the JS code is interpreted and executed when it's **firstly loaded by the HTML page**.

This means that, when the browser loads the HTML page and finds a `<script>` tag, it:

1. Loads the file
1. Parses the code
1. Executes the code
   > If your code **creates and attaches event handlers** to element, the browser will do so... but only on elements that **already exists**!
1. Stores functions in memory for future executions
1. Continues parsing the HTML file

> That's it. After that, your JS code will **not be executed again**.

So... when you create, at a later time, new DOM nodes, events **won't be attached to them**; the "attach events to elements" phase **has already happenned**.

---
### Parent's responsibility

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#64">Feature : _"Remove messages"_</a>]

To resolve this issue, the solution is to register the event **not on the element itself**, but on **one of its parents that is present** at page load.

In our case, this parent could be the `#dialog` element.

The `.on(...)` method allows you to register an event on a node that can only be **triggered by one of its  descendants**, not itself.

In our case, we want to register an event on the `#dialog` element, but trigger it only when a child `button` is clicked:

> The arguments are : the `name` of the event, the `selector` of the descendant element, and the callbakc `function`.

```js
$("#dialog").on("click", "button", function (event) {
  // 'this' still represent the clicked button
  // So we can reuse the same code as before.
  $(this).closest("div.col-8").remove();
});
```

> You can register other events than `click`.

---
### Complete code

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a> > <a href="#64">Feature : _"Remove messages"_</a>]

Here's the complete code for this feature:

```js
// Feature : "Remove message"
$("#dialog").on("click", "button", removeMessage);

function removeMessage(event) {
  // 'this' still represent the clicked button
  // So we can reuse the same code as before.
  $(this).closest("div.col-8").remove();
}
```

---
class: center, middle
## Complete App

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]



The complete JS code for this example can be found [here][complete].

> In this complete code, note that the event declarations have been put at the top of the file, and that the function comes after.
>
> This allows a better file structure.

---
## Resources

.breadcrumbs[<a href="#1">jQuery - DOM Manipulation</a>]

**Documentation**

- [jQuery Documentation][jq-doc]
- [List of CSS selectors][css-select]

**Further reading**

- [Tips for good jQuery selectors][5-tips-selec]

[vscode]: https://code.visualstudio.com/
[chrome]: https://www.google.com/chrome/
[js]: ../js
[bs]: ../bootstrap
[dl-jquery]: https://code.jquery.com/jquery-3.1.1.min.js
[ex-file]: https://gist.githubusercontent.com/Tazaf/2ca35d60688eec1281fd9546abe1f76a/raw/index.html
[jq-doc]: http://api.jquery.com/
[ls]: https://www.npmjs.com/package/live-server
[local-bs]: ../bootstrap-basics/#5
[css-select]: https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors
[5-tips-selec]: https://www.sitepoint.com/efficient-jquery-selectors/
[jq-events]: https://api.jquery.com/category/events/
[complete]: https://gist.githubusercontent.com/Tazaf/1eb7e4d4b2bd6a5508b6e2c88f6739c0/raw/script.js
[bs-validation]: https://getbootstrap.com/docs/4.3/components/forms/#supported-elements
[js-in-body]: https://www.google.com/search?q=js+script+in+head+or+body
[template]: https://developer.mozilla.org/fr/docs/Web/HTML/Element/template
[ajax]: https://developer.mozilla.org/fr/docs/Web/Guide/AJAX

    </textarea>
    <script src='https://embed.runkit.com'></script>
    <script src='../../subject-198cec99477e82cb151d.js'></script>
  </body>
</html>
